<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="assets/favicon.png" sizes="any">
<link rel="apple-touch-icon" href="assets/favicon.png">
<title>TSL Tracking</title>
<style>
  :root{color-scheme:light dark}
  body{font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:720px;line-height:1.55}
  .card{border:1px solid #e6e6e6;border-radius:14px;padding:20px;background:#fafafa}
  @media (prefers-color-scheme:dark){ body{background:#111;color:#eee}
    .card{border-color:#333;background:#1a1a1a} code{background:#111;border-color:#333}
    .secondary{background:#2a2a2a;color:#eee} .muted{color:#aaa}}
  h3{margin:0 0 12px}
  code{background:#fff;padding:6px 8px;border-radius:8px;border:1px solid #e6e6e6;display:inline-block;word-break:break-all}
  button{padding:12px 16px;border:0;border-radius:0px;cursor:pointer}
  .primary{background:#073446;color:#fff}
  .secondary{background:#eee;color:#111}
  .muted{color:#666;margin-top:10px}
  .group-button{display:flex; gap:1rem}
</style>
</head>
<body>
<div class="card">
  <h3 id="title">TSL Tracking</h3>
  <p><b>Booking #:</b> <code id="ref"></code></p>
  <p class="muted">Click <b>Copy</b>, then <b>Go to tracking site</b>. For “copy & go” carriers, paste the number there.</p>
  <div class="group-button">
    <button class="primary" id="copyBtn">Copy</button>
    <button class="secondary" id="openBtn">Go to tracking site</button>
    <a id="openLink" target="_blank" rel="noopener noreferrer" style="display:none">open</a>
  </div>
  <p id="status" class="muted"></p>
</div>

<script>
  // --- read params ---
  const qs = new URLSearchParams(location.search);
  const ref = (qs.get('ref') || '').trim();
  const carrierRaw = (qs.get('carrier') || '').trim();

  // --- helpers ---
  const norm = s => String(s||'').toLowerCase().replace(/[\s\-_.]+/g,'').trim();
  const refOK = /^[A-Za-z0-9._\-\/\s]{3,50}$/.test(ref);

  // --- carriers ---
  const carriers = [
    // Deep-link carriers
    { name:'Maersk',      match:/^maersk$/,      mode:'deeplink',
      to: r => `https://www.maersk.com/tracking/#tracking/${encodeURIComponent(r)}` },

    { name:'Hapag-Lloyd', match:/^hapaglloyd|^hapaglloyd$|^hapag-lloyd$|^hapag lloyd$/, mode:'deeplink',
      to: r => `https://www.hapag-lloyd.com/en/online-business/track/track-by-booking-solution.html?booking=${encodeURIComponent(r)}` },

    // MSC: special deep-link with Base64 params
    { name:'MSC',         match:/^msc$/,         mode:'deeplink',
      to: r => {
        // MSC expects base64 of `trackingNumber=<r>&trackingMode=1`
        const params = btoa(`trackingNumber=${r}&trackingMode=1`);
        return `https://www.msc.com/en/track-a-shipment?params=${params}`;
      }},

    // Copy-&-Go carriers (no number in URL)
    { name:'CMA CGM',     match:/^cma$|^cmacgm$|^cma-cgm$/,      mode:'copygo',
      url:'https://www.cma-cgm.com/ebusiness/tracking' },

    { name:'ShipmentLink', match:/^shipmentlink$/,               mode:'copygo',
      url:'https://ct.shipmentlink.com/servlet/TDB1_CargoTracking.do' },

    { name:'Yang Ming',    match:/^yangming$|^yangming$|^yang ming$/, mode:'copygo',
      url:'https://www.yangming.com/en' },

    { name:'Höegh Autoliners', match:/^hoegh$|^hoeghautoliners$|^hoegh-autoliners$/, mode:'copygo',
      url:'https://www.hoeghautoliners.com/my-cargo' },

    { name:'HMM', match:/^hmm$/, mode:'copygo',
      url:'https://www.hmm21.com/e-service/general/DashBoard.do' },

    { name:'ONE (Ocean Network Express)', match:/^one$|^oneline$|^oceannetworkexpress$/, mode:'copygo',
      url:'https://ecomm.one-line.com/one-ecom/manage-shipment/cargo-tracking' },
  ];

  const cfg = carriers.find(c => c.match.test(norm(carrierRaw))) || null;

  // --- render ---
  document.getElementById('title').textContent = cfg
    ? `TSL Tracking for ${cfg.name}`
    : 'TSL Tracking';
  document.getElementById('ref').textContent = ref || '—';

  // Copy
  document.getElementById('copyBtn').addEventListener('click', async () => {
    const status = document.getElementById('status');
    try {
      if (navigator.clipboard && navigator.isSecureContext) {
        await navigator.clipboard.writeText(ref);
      } else {
        const ta = document.createElement('textarea'); ta.value = ref;
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      }
      status.textContent = 'Copied to clipboard.';
    } catch {
      status.textContent = 'Clipboard blocked. Select & copy manually.';
    }
  });

  // Open tracking
  document.getElementById('openBtn').addEventListener('click', () => {
    const status = document.getElementById('status');
    if (!cfg) { status.textContent = 'Carrier not recognized. Open their site manually.'; return; }
    if (!ref) { status.textContent = 'Missing booking number (?ref=...).'; return; }

    const url = cfg.mode === 'deeplink' ? cfg.to(ref) : cfg.url;
    const a = document.getElementById('openLink');
    a.href = url; a.click();
    setTimeout(() => { status.textContent = 'If no tab opened, allow popups and click again.'; }, 250);
  });

  if (!refOK && ref) {
    document.getElementById('status').textContent = 'Note: unusual booking format.';
  }
</script>
</body>
</html>
